***************
*** 96,99 ****
  		assertSame(session1, this.locator.getSessionByKey("a2"));
  		assertSame(session2, this.locator.getSessionByKey("a3"));
  	}
- }
--- 96,125 ----
  		assertSame(session1, this.locator.getSessionByKey("a2"));
  		assertSame(session2, this.locator.getSessionByKey("a3"));
  	}
+ 
+     /**
+      * use ip:port format string to be compatible with
+      * 'nginx-upstream-consistent' module.
+      */
+     @Test
+     public void testSessionKey_CompatibleWithNginxUpstreamConsistent() {
+ 
+         this.locator = new KetamaMemcachedSessionLocator(true);
+ 
+         MockSession session1 = new MockSession(8080);
+ 		MockSession session2 = new MockSession(8081);
+ 		MockSession session3 = new MockSession(8082);
+ 		List<Session> list = new ArrayList<Session>();
+ 		list.add(session1);
+ 		list.add(session2);
+ 		list.add(session3);
+ 		this.locator.updateSessions(list);
+ 
+         assertEquals(session1.getRemoteSocketAddress(),
+                 this.locator.getSessionByKey("127.0.0.1:8080-1").getRemoteSocketAddress());
+         assertEquals(session2.getRemoteSocketAddress(),
+                 this.locator.getSessionByKey("127.0.0.1:8081-2").getRemoteSocketAddress());
+         assertEquals(session3.getRemoteSocketAddress(),
+                 this.locator.getSessionByKey("127.0.0.1:8082-3").getRemoteSocketAddress());
+     }
+ }
